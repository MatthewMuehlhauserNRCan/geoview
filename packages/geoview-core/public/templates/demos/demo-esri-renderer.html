<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESRI Renderer - Canadian Geospatial Platform Viewer</title>
  <link rel="shortcut icon" href="./favicon.ico" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <meta name="msapplication-config" content="./img/browserconfig.xml" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="msapplication-TileColor" content="#da532c" />
  <meta name="theme-color" content="#ffffff" />
  <link rel="stylesheet" href="css/style.css" />

  <style>
    .config-json-valid {
      color: green;
    }

    .config-error {
      color: red;
    }

    .tab-container {
      width: 100%;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
    }

    .tab-link {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      outline: none;
      cursor: pointer;
      padding: 8px 10px;
      transition: background-color 0.3s;
      flex: none;
      text-align: center;
    }

    .tab-link:hover {
      background-color: #ddd;
    }

    .tab-link.active {
      background-color: #ccc;
    }

    .tab-content {
      padding: 16px;
      border: 1px solid #ccc;
      border-top: none;
    }

    .editor {
      display: inline-flex;
      gap: 10px;
      font-family: monospace;
      line-height: 21px;
      background: #282a3a;
      border-radius: 2px;
      padding: 20px 10px;
      height: 500px;
      overflow-y: auto;
    }

    .line-numbers {
      width: 20px;
      text-align: right;
      height: 9999px;
    }

    .line-numbers span {
      counter-increment: linenumber;
    }

    .line-numbers span::before {
      content: counter(linenumber);
      display: block;
      color: #506882;
    }

    textarea {
      height: 99999px;
      line-height: 21px;
      overflow-y: hidden;
      padding: 0;
      border: 0;
      background: #282a3a;
      color: #fff;
      min-width: 500px;
      outline: none;
      resize: none;
      overflow-x: auto;
      white-space: nowrap;
    }

    label {
      font-size: 14px;
      font-style: italic;
    }

    #serviceUrlInput {
      width: 700px;
    }
  </style>
</head>

<body>
  <div class="header-table">
    <table>
      <tbody>
        <tr>
          <td><img class="header-logo" alt="logo" src="./img/Logo.png" /></td>
          <td class="header-title">
            <h1><strong>Sandbox Configuration</strong></h1>
          </td>
        </tr>
      </tbody>
    </table>
    <table>
      <tbody>
        <tr>
          <td><a href="./index.html">Main</a><br /></td>
        </tr>
      </tbody>
    </table>
    <table>
      <tbody>
        <tr>
          <td>This page is used to create a valid GeoView style config from an ESRI Renderer.
            If a Feature Service URL is provided, then a layer config with the style included will be generated.
          <br>
          Example: <i>https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/earthquakes_en/MapServer/0</i>
          </td>
        </tr>
        <tr>
          <td>
            <label for="serviceUrlInput">ESRI Feature Service URL (optional)</label>
            <input type="text" id="serviceUrlInput" name="serviceUrl">
          </td>
        </tr>
        <tr>
          <td>
            <button id="executeButton">Execute</button>
          </td>
        </tr>
        <tr>
          <td>
            <span>Input ESRI Renderer</span>
            <div class="editor">
              <div class="line-numbers" id="inputLineNumbers">
                <span></span>
              </div>
              <textarea id="inputTextArea" cols="110">
              </textarea>
            </div>
            <div>
              &nbsp;
            </div>
          </td>
          <td>
            <span>Style configuration:</span>
            <span id="messageTab1">File not validated...</span>
            <div class="editor">
              <div class="line-numbers" id="outputLineNumbers">
                <span></span>
              </div>
              <textarea id="outputTextArea" cols="110">
              </textarea>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="map-title-holder">
    <h4 id="HLCONF1">Sanbox Map</h4>
    <a class="ref-link" href="#top">Top</a>
  </div>
  <div id="mapSection">
    <div id="sandboxMap"></div>
  </div>
  <p>This map loads it's configurations from the text area.</p>
  <hr />

  <button type="button" class="collapsible">Code Snippet</button>
  <pre id="codeSnippet" class="panel"></pre>

  <script src="codedoc.js"></script>
  
  <script>
    // Function used to generate line numbers in the input and output containers.
    generateLineNumbers = (textContainerId, lineNumbersContainerId) => {
      const textarea = document.getElementById(textContainerId);
      const lineNumbersContainer = document.getElementById(lineNumbersContainerId);
      const lines = textarea.value.split('\n').length + 1;
      const lineNumbers = Array.from({ length: lines }, (_, index) => '').join('<span />');
      lineNumbersContainer.innerHTML = lineNumbers;
    };

    const initialValue = {
      "type": "simple",
      "symbol": {
        "type": "esriSMS",
        "color": [
          255,
          130,
          0,
          217
        ],
        "angle": 0,
        "xoffset": 0,
        "yoffset": 0,
        "size": 6,
        "style": "esriSMSCircle",
        "outline": {
          "type": "esriSLS",
          "color": [
            255,
            255,
            255,
            128
          ],
          "width": 0.998,
          "style": "esriSLSSolid"
        }
      }
    }
    
    const executeButton = document.getElementById('executeButton');
    const intputTextArea = document.getElementById('inputTextArea');
    inputTextArea.value = JSON.stringify(initialValue, undefined, 2);
    generateLineNumbers('inputTextArea', 'inputLineNumbers');

    const outputTextArea = document.getElementById('outputTextArea');
    const serviceUrlInput = document.getElementById('serviceUrlInput');

    executeButton.addEventListener('click', async (e) => {
      const geoViewRenderer = cgpv.api.config.getStyleFromESRIRenderer(inputTextArea.value);
      if (serviceUrlInput.value) {
        const urlArray = serviceUrlInput.value.split("/");
        const index = urlArray.pop();
        const serviceUrl = urlArray.join("/");
        const geoviewConfig = await cgpv.api.config.createLayerConfig(serviceUrl, "esriFeature", [index]);
        geoviewConfig.listOfLayerEntryConfig[0].layerStyle = geoViewRenderer;
        outputTextArea.value = JSON.stringify(geoviewConfig, undefined, 2);
      } else {
        outputTextArea.value = JSON.stringify(geoViewRenderer, undefined, 2);
      }
      generateLineNumbers('outputTextArea', 'outputLineNumbers');
    })

    // Utility functions ========================================================================================================


    // Function used to display messages to report progression of the process.
    printMessage = (messageObject, messageString, status) => {
      if (status === 'error') {
        messageObject.classList.remove('config-json-valid');
        messageObject.classList.add('config-error');
      } else {
        messageObject.classList.add('config-json-valid');
        messageObject.classList.remove('config-error');
      }
      messageObject.innerHTML = messageString;
    }

    // Function used to create the string needed to display the error status of the different layerPath.
    generateLayerPathErrorFlag = (listOfLayerEntryConfig, buffer = '', prefix = '') => {
      listOfLayerEntryConfig.forEach((layer) => {
        buffer = buffer ? `${buffer}\n` : '';
        buffer = `${buffer}${layer?.getLayerPath?.() || layer.layerName}: ${layer?.getErrorDetectedFlag?.() ? 'ERROR' : 'Ok'}`;
        if (layer.isLayerGroup) buffer = generateLayerPathErrorFlag(layer.listOfLayerEntryConfig, buffer, prefix ? `${prefix}.${layer.layerId}` : layer.layerId);
      });
      return buffer;
    }

    // Function used to compute and display execution time.
    displayExecutionTime = (startTime, timeContainerId) => {
      // Calculate the time span between now and start date
      let timeSpan = new Date().getTime() - startTime;

      const days = Math.floor(timeSpan / (1000 * 60 * 60 * 24));
      timeSpan -= days * (1000 * 60 * 60 * 24);

      const hours = Math.floor(timeSpan / (1000 * 60 * 60));
      timeSpan -= hours * (1000 * 60 * 60);

      const mins = Math.floor(timeSpan / (1000 * 60));
      timeSpan -= mins * (1000 * 60);

      const seconds = Math.floor(timeSpan / 1000);
      timeSpan -= seconds * 1000;

      // Let's say we always want seconds and milliseconds at least
      let timeToDisplay = `${seconds} seconds, and ${timeSpan} ms`;
      if (mins) timeToDisplay = `${mins} minutes, ${seconds} seconds, and ${timeSpan} ms`;
      if (hours) timeToDisplay = `${hours} hours, ${mins} minutes, ${seconds} seconds, and ${timeSpan} ms`;

      // display time in its container
      document.getElementById(timeContainerId).innerHTML = `Execution time: ${timeToDisplay}`;
    }

    displayMapConfig = (mapConfig, tabId) => {
      // Scan the layer structure to see if there is an eroneous layer.
      const noErrorDetected = !mapConfig.map.listOfGeoviewLayerConfig.reduce((accumulator, geoviewLayer) => {
        // Create a recursive function that scans the layer structure for erroneous sublayers. This function is used in the following line.
        const subLayerError = (listOfLayerEntryConfig) => {
          return listOfLayerEntryConfig.reduce((accumulator, subLayer) => {
            if (subLayer.isLayerGroup) return accumulator || subLayer.getErrorDetectedFlag() || subLayerError(subLayer.listOfLayerEntryConfig);
            return accumulator || subLayer.getErrorDetectedFlag();
          }, false);
        }
        return accumulator || geoviewLayer.getErrorDetectedFlag() || subLayerError(geoviewLayer.listOfLayerEntryConfig);
      }, false);

      // Scan the layer structure to generate the raw metadata string.
      geoviewLayerMetadataString = mapConfig.map.listOfGeoviewLayerConfig.reduce((accumulator, geoviewLayer) => {
        // Create a recursive function that scans the layer structure for sublayers metadata. This function is used in the following line.
        const subLayerMetadata = (listOfLayerEntryConfig) => {
          return listOfLayerEntryConfig.reduce((accumulator, subLayer) => {
            if (subLayer.isLayerGroup) return `${accumulator}\nLayer Group ${subLayer.layerId}\n${subLayerMetadata(subLayer.listOfLayerEntryConfig)}`;
            return `${accumulator}\nLayer Leaf ${subLayer.layerId}\n${JSON.stringify(subLayer.getLayerMetadata(), undefined, 2)}`;
          }, '');
        }
        const sublayerInfo = subLayerMetadata(geoviewLayer.listOfLayerEntryConfig);
        const geoviewInfo = `Geoview Layer ${geoviewLayer.geoviewLayerId}\n${JSON.stringify(geoviewLayer.getServiceMetadata(), undefined, 2)}\n`;
        return `${accumulator}\n${geoviewInfo}\n${sublayerInfo}`;
      }, '');

      // If no geoview and sub layer error was detected
      if (noErrorDetected) printMessage(document.getElementById(`message${tabId}`), 'Map Config instance created and all layers are valid.');
      else printMessage(document.getElementById(`message${tabId}`), 'Map Config instance created, but it contains invalid layers.', 'error');

      // Set the global variables associated to the Element Display zone.
      mapConfigString = mapConfig.serialize();
      geoviewLayerString = mapConfig.map.listOfGeoviewLayerConfig.reduce((accumulator, geoviewLayer) => {
        return `${accumulator}== ${geoviewLayer.geoviewLayerId} ===============================================================================================\n${geoviewLayer.serialize()}\n`;
      }, '');
      layerPathErrorFlag = mapConfig.map.listOfGeoviewLayerConfig.reduce((accumulator, geoviewLayer) => {
        return `${accumulator}${generateLayerPathErrorFlag(geoviewLayer.listOfLayerEntryConfig, `geoviewLayerId ${geoviewLayer.geoviewLayerId}: ${geoviewLayer.getErrorDetectedFlag() ? 'ERROR' : 'Ok'}\nlistOfLayerEntryConfig:`)}\n\n`;
      }, '');
    }

    // create snippets
    // window.addEventListener('load', () => {
    //   createCodeSnippet();
    //   createConfigSnippet();
    // });
  </script>
</body>

</html>